Context: You are an AI senior software developer agent working on the iLearn LMS project in the repository azeemushaan/ilearn. The environment has TypeScript/Next.js 15 code, Firebase Auth integration, Firestore converters, admin utilities, AI MCQ generation pipeline (Gemini), and a comprehensive manual video processing system with YouTube OAuth integration, credit management, and step-by-step teacher-controlled workflow.

Goal: The system implements a robust, teacher-controlled video processing workflow where:
- Playlist ingestion does NOT trigger auto-processing
- Teachers manually process videos step-by-step (fetch captions → segment → generate MCQs → build manifest)
- YouTube OAuth with ownership verification and 24h caching
- Credit-based AI transcription (1 credit/minute, 2 min for < 60s videos)
- Explicit status tracking (not_ready, processing, ready, failed) with student/coach visibility rules
- Comprehensive logging and audit trails for all processing steps

The project uses Vitest for unit tests and Playwright for E2E.

Completed Core Features

✅ Manual Video Processing Workflow
- Playlist ingestion fetches metadata only (no auto-processing)
- Step-by-step processing: fetch captions → segment → generate MCQs → build manifest
- Each step has dedicated API endpoint with proper validation and logging

✅ YouTube OAuth Integration
- One-time OAuth connection per teacher (multi-channel support)
- Ownership verification with 24h caching
- Batch ownership preflight for playlists
- Token refresh and expiration handling

✅ Caption Source Management
- OAuth (YouTube-owned videos only, with ownership verification)
- SRT/VTT upload (max 200MB, timestamp validation, overlap detection)
- AI Transcription (credit-based, not yet fully implemented)

✅ Credit Management System
- Credit balance tracking per coach
- Reserve/consume/refund transaction flow
- 1 credit = 1 minute video, 2 credits minimum for < 60s
- Prevents processing without sufficient credits

✅ Status & Visibility
- 4 statuses: not_ready (yellow), processing (blue), ready (green), failed (red)
- Students see yellow/blue/green only; coaches see all 4
- Real-time status polling API for processing updates

✅ Logging & Audit
- Per-video processing logs (step, status, actor, duration, credits, errors)
- Audit trail for all processing actions
- Firestore-based log storage under videos/{videoId}/processing/logs

Remaining Tasks

UI Components & Teacher Dashboard
- Build YouTube connection card for settings page
- Overhaul assignment detail page with per-video Process buttons and status chips
- Create Process Video modal (source selection, language picker, progress tracking)
- Build Batch Processing modal with ownership preflight
- Implement notification bell component

Batch Processing System
- Batch job creation, status tracking, retry, cancel APIs
- Queue management for concurrent processing
- Per-video status within batch jobs

Admin Features
- Processing queue dashboard showing all active jobs
- Credit overview and transaction history
- Admin settings for source toggles, engine config, concurrency limits

Student Experience
- Filter failed videos from student views
- Show friendly messages for yellow/blue statuses
- Ensure last known good manifest is served for failed videos

Analytics & Question Review
- Assignment progress aggregation API
- Coach analytics dashboard
- Question review and editing pages

Security & Testing
- Tighten Firestore rules (prevent enumeration, enforce coach-scoped access)
- Storage rules for manifests and captions
- Comprehensive unit and E2E tests

Migration
- Data migration script for existing videos
- Add new fields with safe defaults
- Initialize coach_billing documents

Guidelines

Use existing helper functions in src/lib/firebase for admin Firestore/Storage access and authentication. Follow patterns used in src/app/api/videos/[videoId]/prepare/route.ts for error handling and logging.

Maintain strict TypeScript types and Zod schemas for request/response validation. Define new types in src/lib/schemas.

When updating security rules, keep backward compatibility for already implemented billing/admin features. Use helper functions (isCoachScoped, isAdmin, etc.) to minimise duplication.

Write clear, concise tests. Where Firestore transactions or asynchronous functions are involved, mock or stub external services.

Document any new environment variables or dependencies in the README.md and IMPLEMENTATION_SUMMARY.md

When implementing the system always keep .qoder > rules > general.md in the context

Good luck! Once all tasks are complete and the application runs successfully, you can commit the changes and notify the user.