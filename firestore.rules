/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a strict user-ownership and role-based access model.
 *
 * Data Structure:
 * - /coaches/{coachId}: Coach-specific data.
 * - /users/{userId}: User data, linked to a coach.
 * - /plans/{planId}: Subscription plan information (public read, admin-only write).
 * - /subscriptions/{subId}: Coach subscription details (admin-only).
 * - /payments/{paymentId}: Payment records (admin-only).
 * - /invoices/{invoiceId}: Invoices for coaches (admin-only).
 * - /audit/{auditId}: Audit logs (admin-only).
 * - /settings/theme: Global theme settings (public read, admin-only write).
 * - /teacher_subscriptions/{id}: Legacy subscriptions (admin-only).
 * - /subscription_plans/{planId}: Duplicate of /plans for the pricing page (public read, admin-only write).
 *
 * Key Security Decisions:
 * - Users can only access their own data under /users/{userId}.
 * - Coaches have no direct data access in this model.  All data is accessed through users.
 * - Listing of users is disallowed for security.
 * - Admin access (create, update, delete) for plans, subscriptions, payments, invoices, audit logs, theme settings, and legacy subscriptions is not yet implemented. Add `isAdmin()` checks in the future, using custom claims.
 *
 * Denormalization for Authorization:
 * - The `User` entity includes a `coachId` field, which is validated against the `coachId` in the user's custom claims. This ensures that users can only access data within their assigned coach.
 *
 * Structural Segregation:
 * - No public vs. private data segregation is used in this initial ruleset.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     * @path N/A
     * @allow N/A
     * @deny N/A
     * @principle Verifies user authentication.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user's ID matches the provided userId.
     * @path N/A
     * @allow User with UID 'user123' accessing /users/user123.
     * @deny User with UID 'user456' accessing /users/user123.
     * @principle Enforces document ownership.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user's ID matches the provided userId and that the resource exists.
     * @path N/A
     * @allow User with UID 'user123' updating existing document /users/user123.
     * @deny User with UID 'user456' updating /users/user123 or user123 updating a non-existent document.
     * @principle Enforces document ownership and existence for writes.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && exists(resource.data);
    }
    
        /**
     * @description Checks if the authenticated user has the 'admin' role.
     * @path N/A
     */
    function isAdmin() {
      return isSignedIn() && request.auth.token.role == 'admin';
    }

    /**
     * @description Rules for the /coaches collection.
     * @path /coaches/{coachId}
     * @allow User with coachId 'coach123' can read their own coach document. (get)
     * @deny User with coachId 'coach456' trying to read coach document 'coach123'. (get)
     * @allow User with coachId 'coach123' can create their own coach document. (create)
     * @deny User with coachId 'coach456' trying to create coach document 'coach123'. (create)
     * @principle Enforces document ownership.
     */
    match /coaches/{coachId} {
      // Read permissions: Only the coach can read their own document
      allow get: if isOwner(coachId);
      allow list: if false;

      // Write permissions: Only the coach can create, update, and delete their own document.
      allow create: if isOwner(coachId);
      allow update: if isExistingOwner(coachId);
      allow delete: if isExistingOwner(coachId);
    }

    /**
     * @description Rules for the /users collection.
     * @path /users/{userId}
     * @allow User with UID 'user123' can read their own user document. (get)
     * @deny User with UID 'user456' trying to read user document 'user123'. (get)
     * @allow User with UID 'user123' can create their own user document. (create)
     * @deny User with UID 'user456' trying to create user document 'user123'. (create)
     * @principle Enforces document ownership and validates coachId on create.
     */
    match /users/{userId} {
      // Read permissions: Only the user can read their own document
      allow get: if isOwner(userId);
      allow list: if false; // Listing users is disallowed

      // Write permissions:
      // - Create: Only the user themselves can create their document, and the coachId must match the custom claim.
      // - Update/Delete: Only the user themselves can update/delete their document.
      allow create: if isOwner(userId) && request.resource.data.coachId == request.auth.token.coachId;
      allow update: if isExistingOwner(userId) && request.resource.data.coachId == resource.data.coachId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for the /plans collection.
     * @path /plans/{planId}
     * @allow Any user can read plan details. (get, list)
     * @deny Non-admin user trying to create, update, or delete a plan. (create, update, delete)
     * @principle Public read, admin-only write (not yet implemented).
     */
    match /plans/{planId} {
      // Read permissions: Publicly readable
      allow get, list: if true;

      // Write permissions: Only admins can create, update, and delete plans.
      // TODO: Add isAdmin() check once custom claims are set up.
      allow create, update, delete: if isAdmin();
    }
    
        /**
     * @description Rules for the /subscriptions collection.
     * @path /subscriptions/{subId}
     * @allow Any user can read subscription details. (get, list)
     * @deny Non-admin user trying to create, update, or delete a subscription. (create, update, delete)
     * @principle Public read, admin-only write (not yet implemented).
     */
    match /subscriptions/{subId} {
      // Read permissions: Publicly readable
      allow get, list: if isAdmin();

      // Write permissions: Only admins can create, update, and delete subscriptions.
      // TODO: Add isAdmin() check once custom claims are set up.
      allow create, update, delete: if isAdmin();
    }
    
            /**
     * @description Rules for the /payments collection.
     * @path /payments/{paymentId}
     * @allow Any user can read payment details. (get, list)
     * @deny Non-admin user trying to create, update, or delete a payment. (create, update, delete)
     * @principle Public read, admin-only write (not yet implemented).
     */
    match /payments/{paymentId} {
      // Read permissions: Publicly readable
      allow get, list: if isAdmin();

      // Write permissions: Only admins can create, update, and delete payments.
      // TODO: Add isAdmin() check once custom claims are set up.
      allow create, update, delete: if isAdmin();
    }
    
                /**
     * @description Rules for the /invoices collection.
     * @path /invoices/{invoiceId}
     * @allow Any user can read invoice details. (get, list)
     * @deny Non-admin user trying to create, update, or delete a invoice. (create, update, delete)
     * @principle Public read, admin-only write (not yet implemented).
     */
    match /invoices/{invoiceId} {
      // Read permissions: Publicly readable
      allow get, list: if isAdmin();

      // Write permissions: Only admins can create, update, and delete invoices.
      // TODO: Add isAdmin() check once custom claims are set up.
      allow create, update, delete: if isAdmin();
    }
    
    /**
     * @description Rules for the /audit collection.
     * @path /audit/{auditId}
     * @allow Any user can read audit details. (get, list)
     * @deny Non-admin user trying to create, update, or delete a audit log. (create, update, delete)
     * @principle Public read, admin-only write (not yet implemented).
     */
    match /audit/{auditId} {
      // Read permissions: Publicly readable
      allow get, list: if isAdmin();

      // Write permissions: Only admins can create, update, and delete audits.
      // TODO: Add isAdmin() check once custom claims are set up.
      allow create, update, delete: if isAdmin();
    }
    
        /**
     * @description Rules for the /settings/theme document.
     * @path /settings/theme
     * @allow Any user can read the theme settings. (get)
     * @deny Non-admin user trying to create, update, or delete the theme settings. (create, update, delete)
     * @principle Public read, admin-only write (not yet implemented).
     */
    match /settings/theme {
      allow get: if true;
      allow list: if false;

      // Write permissions: Only admins can update the theme.
      // TODO: Add isAdmin() check once custom claims are set up.
      allow create, update, delete: if isAdmin();
    }
    
    /**
     * @description Rules for the /teacher_subscriptions collection.
     * @path /teacher_subscriptions/{id}
     */
    match /teacher_subscriptions/{id} {
        allow get, list: if isAdmin();
        allow create, update, delete: if isAdmin();
    }

    /**
     * @description Rules for the /subscription_plans collection (duplicate of /plans).
     * @path /subscription_plans/{planId}
     * @allow Any user can read plan details. (get, list)
     * @deny Non-admin user trying to create, update, or delete a plan. (create, update, delete)
     * @principle Public read, admin-only write (not yet implemented).
     */
    match /subscription_plans/{planId} {
      // Read permissions: Publicly readable
      allow get, list: if true;

      // Write permissions: Only admins can create, update, and delete plans.
      // TODO: Add isAdmin() check once custom claims are set up.
      allow create, update, delete: if isAdmin();
    }

  }
}