rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Admin override
    match /{document=**} {
      allow read, write: if isAdmin();
    }

    match /coaches/{coachId} {
      allow get: if isCoachOwner(coachId);
      allow list: if false;
      allow create: if isCoachOwner(coachId) && isRequestCoach(coachId);
      allow update, delete: if isCoachOwner(coachId) && isRequestCoach(coachId);
    }

    match /users/{userId} {
      allow get: if isSelf(userId) || (isCoachScoped(resource.data.coachId) && isCoachMember(resource.data.coachId));
      allow list: if false;
      allow create: if isSelf(userId) && isRequestCoach(request.resource.data.coachId);
      allow update: if isSelf(userId) || (isCoachMember(resource.data.coachId) && isRequestCoach(resource.data.coachId));
      allow delete: if isSelf(userId);
    }

    match /plans/{planId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    match /subscriptions/{subId} {
      allow get: if isCoachScoped(resource.data.coachId) && isCoachMember(resource.data.coachId);
      allow list: if false;
      allow create: if isCoachScoped(request.resource.data.coachId) && isCoachMember(request.resource.data.coachId);
      allow update, delete: if isCoachScoped(resource.data.coachId) && isCoachMember(resource.data.coachId);
    }

    match /payments/{paymentId} {
      allow get: if isCoachScoped(resource.data.coachId) && isCoachMember(resource.data.coachId);
      allow list: if false;
      allow create: if isCoachScoped(request.resource.data.coachId) && isCoachMember(request.resource.data.coachId);
      allow update, delete: if false;
    }

    match /invoices/{invoiceId} {
      allow get: if isCoachScoped(resource.data.coachId) && isCoachMember(resource.data.coachId);
      allow list: if false;
      allow create: if isCoachScoped(request.resource.data.coachId) && isCoachMember(request.resource.data.coachId);
      allow update, delete: if false;
    }

    match /audit/{auditId} {
      allow get: if isCoachScoped(resource.data.coachId) && isCoachMember(resource.data.coachId);
      allow list: if false;
      allow create: if false;
      allow update, delete: if false;
    }

    match /teacher_subscriptions/{id} {
      allow get: if isCoachScoped(resource.data.coachId) && isCoachMember(resource.data.coachId);
      allow list: if false;
      allow create: if isCoachScoped(request.resource.data.coachId) && isCoachMember(request.resource.data.coachId);
      allow update, delete: if false;
    }
  }

  function isAdmin() {
    return request.auth != null && request.auth.token.role == 'admin';
  }

  function isSelf(userId) {
    return request.auth != null && request.auth.uid == userId;
  }

  function requestCoachId() {
    return request.auth != null ? request.auth.token.coachId : null;
  }

  function isCoachOwner(coachId) {
    return requestCoachId() == coachId;
  }

  function isCoachScoped(coachId) {
    return coachId != null && coachId == requestCoachId();
  }

  function isCoachMember(coachId) {
    return request.auth != null && requestCoachId() == coachId;
  }

  function isRequestCoach(coachId) {
    return request.resource.data.coachId == coachId;
  }
}
