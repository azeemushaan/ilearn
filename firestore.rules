/**
 * @file Firebase Security Rules for iLearn Platform
 *
 * @Core Philosophy:
 * This ruleset enforces a user-ownership model for user-specific data and an organization-based access control model for shared resources.
 * Administrative privileges are granted based on the 'role' field in the user document.
 *
 * @Data Structure:
 * The database is organized into top-level collections for organizations, users, classes, playlists, videos, assignments, progress, attempts, and subscription plans.
 * Data is generally namespaced under an organization ID to ensure isolation and access control.
 *
 * @Key Security Decisions:
 * - Users can only read/write their own user document.
 * - Only authenticated users can access the platform.
 * - Administrative roles are required to manage subscription plans.
 * - Data is denormalized (orgId, userId) to avoid complex queries in security rules.
 * - Listing user documents is disallowed.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user's ID matches the provided user ID.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user's ID matches the provided user ID and resource exists.
     */
    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }

    /**
     * @description Checks if the authenticated user has the 'admin' role.
     */
    function isAdmin() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    /**
     * @description Checks if the authenticated user is a teacher and the organization ID matches.
     */
    function isTeacherForOrg(orgId) {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'teacher'
          && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.orgId == orgId;
    }
    
    /**
     * @description Checks if the authenticated user is a student and the organization ID matches.
     */
    function isStudentForOrg(orgId) {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'student'
          && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.orgId == orgId;
    }

    /**
     * @description Rules for the /organizations collection.
     * @path /organizations/{orgId}
     * @allow (get) Authenticated user can read organization data.
     * @deny (create) Only the backend or a process with appropriate credentials should create organizations.
     * @principle Requires authentication for read access and restricts creation to prevent unauthorized organization creation.
     */
    match /organizations/{orgId} {
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rules for the /users collection.
     * @path /users/{userId}
     * @allow (get) Authenticated user can read their own user data.
     * @allow (create) Authenticated user can create their own user data (self-registration).
     * @deny (update) Authenticated user cannot update another user's data.
     * @deny (list) Listing users is not allowed.
     * @principle Enforces document ownership for reads and writes, restricting access to a user's own data.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if false;
    }

    /**
     * @description Rules for the /classes collection.
     * @path /classes/{classId}
     * @allow (get) Authenticated user can read class data.
     * @deny (create) Only authorized users can create classes.
     * @principle Requires authentication for read access and restricts creation to prevent unauthorized class creation.
     */
    match /classes/{classId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isTeacherForOrg(request.resource.data.orgId);
      allow update: if isTeacherForOrg(resource.data.orgId);
      allow delete: if false;
    }

    /**
     * @description Rules for the /playlists collection.
     * @path /playlists/{playlistId}
     * @allow (get) Authenticated user can read playlist data.
     * @deny (create) Only authorized users can create playlists.
     * @principle Requires authentication for read access and restricts creation to prevent unauthorized playlist creation.
     */
    match /playlists/{playlistId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isTeacherForOrg(request.resource.data.orgId);
      allow update: if isTeacherForOrg(resource.data.orgId);
      allow delete: if false;
    }

    /**
     * @description Rules for the /videos collection.
     * @path /videos/{videoId}
     * @allow (get) Authenticated user can read video data.
     * @deny (create) Only authorized users can create videos.
     * @principle Requires authentication for read access and restricts creation to prevent unauthorized video creation.
     */
    match /videos/{videoId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isTeacherForOrg(request.resource.data.orgId);
      allow update: if isTeacherForOrg(resource.data.orgId);
      allow delete: if false;
    }

    /**
     * @description Rules for the /videos/{videoId}/segments collection.
     * @path /videos/{videoId}/segments/{segmentId}
     * @allow (get) Authenticated user can read segment data.
     * @deny (create) Only authorized users can create segments.
     * @principle Requires authentication for read access and restricts creation to prevent unauthorized segment creation.
     */
    match /videos/{videoId}/segments/{segmentId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isTeacherForOrg(get(/databases/$(database)/documents/videos/$(videoId)).data.orgId);
      allow update: if isTeacherForOrg(get(/databases/$(database)/documents/videos/$(videoId)).data.orgId);
      allow delete: if false;
    }

    /**
     * @description Rules for the /videos/{videoId}/segments/{segmentId}/questions collection.
     * @path /videos/{videoId}/segments/{segmentId}/questions/{questionId}
     * @allow (get) Authenticated user can read question data.
     * @deny (create) Only authorized users can create questions.
     * @principle Requires authentication for read access and restricts creation to prevent unauthorized question creation.
     */
    match /videos/{videoId}/segments/{segmentId}/questions/{questionId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isTeacherForOrg(get(/databases/$(database)/documents/videos/$(videoId)).data.orgId);
      allow update: if isTeacherForOrg(get(/databases/$(database)/documents/videos/$(videoId)).data.orgId);
      allow delete: if false;
    }

    /**
     * @description Rules for the /assignments collection.
     * @path /assignments/{assignmentId}
     * @allow (get) Authenticated user can read assignment data.
     * @deny (create) Only authorized users can create assignments.
     * @principle Requires authentication for read access and restricts creation to prevent unauthorized assignment creation.
     */
    match /assignments/{assignmentId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isTeacherForOrg(request.resource.data.orgId);
      allow update: if isTeacherForOrg(resource.data.orgId);
      allow delete: if false;
    }

    /**
     * @description Rules for the /progress collection.
     * @path /progress/{progressId}
     * @allow (get) Authenticated user can read progress data.
     * @deny (create) Only authorized users can create progress entries.
     * @principle Requires authentication for read access and restricts creation to prevent unauthorized progress creation.
     */
    match /progress/{progressId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isStudentForOrg(get(/databases/$(database)/documents/users/$(request.resource.data.userId)).data.orgId);
      allow update: if isStudentForOrg(get(/databases/$(database)/documents/users/$(resource.data.userId)).data.orgId);
      allow delete: if false;
    }

    /**
     * @description Rules for the /attempts collection.
     * @path /attempts/{attemptId}
     * @allow (get) Authenticated user can read attempt data.
     * @deny (create) Only authorized users can create attempt entries.
     * @principle Requires authentication for read access and restricts creation to prevent unauthorized attempt creation.
     */
    match /attempts/{attemptId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isStudentForOrg(get(/databases/$(database)/documents/users/$(request.resource.data.userId)).data.orgId);
      allow update: if isStudentForOrg(get(/databases/$(database)/documents/users/$(resource.data.userId)).data.orgId);
      allow delete: if false;
    }

    /**
     * @description Rules for the /subscription_plans collection.
     * @path /subscription_plans/{subscriptionPlanId}
     * @allow (get) Authenticated user can read subscription plan data.
     * @deny (create) Only admins can create subscription plans.
     */
    match /subscription_plans/{subscriptionPlanId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if false;
    }

    /**
     * @description Rules for the /teacher_subscriptions collection.
     * @path /teacher_subscriptions/{teacherSubscriptionId}
     */
    match /teacher_subscriptions/{teacherSubscriptionId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isAdmin(); // Only admins can create new teacher subscriptions
      allow update: if isAdmin(); // Only admins can update teacher subscriptions
      allow delete: if false;
    }
  }
}