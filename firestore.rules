/**
 * @fileoverview Firestore Security Rules for the application.
 *
 * Core Philosophy:
 * This ruleset enforces a multi-tenant data model where data is primarily segmented by `coachId`.
 * Most collections are locked down to owner-only access for writes, with public read access where appropriate.
 * User data is strictly controlled, ensuring that users can only manage their own profiles.
 *
 * Data Structure:
 * - /coaches/{coachId}: Coach-specific data.
 * - /users/{userId}: User accounts, linked to a coach.
 * - /plans/{planId}: Publicly readable subscription plans.
 * - /subscriptions/{subId}: Coach subscription details.
 * - /payments/{paymentId}: Payment records for coaches.
 * - /invoices/{invoiceId}: Invoices for coaches.
 * - /audit/{auditId}: Audit logs.
 * - /settings/theme: Global theme settings (unsecured).
 * - /teacher_subscriptions/{id}: Legacy subscription data.
 * - /subscription_plans/{planId}: Publicly readable subscription plans.
 *
 * Key Security Decisions:
 * - User listing is disabled to prevent enumeration attacks.
 * - Public read access is granted to the `/plans` and `/subscription_plans` collections as per the request, allowing display on a landing page.
 * - The default security posture is strict: if a relationship or access pattern is unclear, access is denied.
 *
 * Denormalization for Authorization:
 * - The `User` entity includes a `coachId` field to simplify authorization checks, avoiding the need to query the `/coaches` collection.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is authenticated.
     * @returns {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user is the owner of the resource.
     * @param {string} userId - The user ID to compare against the authenticated user's ID.
     * @returns {boolean} True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user is the owner of the existing resource.
     * @param {string} userId - The user ID to compare against the authenticated user's ID.
     * @returns {boolean} True if the user is the owner and the resource exists, false otherwise.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Grants or denies access to coach documents.
     * @path /coaches/{coachId}
     * @allow (create) - Authenticated user can create a coach document if the coachId matches their UID.
     * @allow (get, list, update, delete) - Only the coach themselves can read, update, or delete their own document.
     * @deny (create) - If the coachId does not match the authenticated user's UID.
     * @principle Enforces document ownership for writes.
     */
    match /coaches/{coachId} {
      allow get: if false;
      allow list: if false;
      allow create: if isOwner(coachId);
      allow update: if isExistingOwner(coachId);
      allow delete: if isExistingOwner(coachId);
    }

    /**
     * @description Grants or denies access to user documents.
     * @path /users/{userId}
     * @allow (create) - Authenticated user can create a user document if the userId matches their UID.
     * @allow (get, update, delete) - Only the user themselves can read, update, or delete their own document.
     * @deny (create) - If the userId does not match the authenticated user's UID.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Grants or denies access to plan documents.
     * @path /plans/{planId}
     * @allow (get, list) - Any user can read plan details.
     * @deny (create, update, delete) - No user can create, update, or delete plan details.
     * @principle Allows public read access.
     */
    match /plans/{planId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Grants or denies access to subscription documents.
     * @path /subscriptions/{subId}
     * @allow (create) - No user can create subscription details.
     * @allow (get, list, update, delete) - No user can get, list, update or delete subscription details.
     * @principle Denies all access.
     */
    match /subscriptions/{subId} {
      allow get: if false;
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Grants or denies access to payment documents.
     * @path /payments/{paymentId}
     * @allow (create) - No user can create payment records.
     * @allow (get, list, update, delete) - No user can get, list, update or delete payment records.
     * @principle Denies all access.
     */
    match /payments/{paymentId} {
      allow get: if false;
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Grants or denies access to invoice documents.
     * @path /invoices/{invoiceId}
     * @allow (create) - No user can create invoice details.
     * @allow (get, list, update, delete) - No user can get, list, update or delete invoice details.
     * @principle Denies all access.
     */
    match /invoices/{invoiceId} {
      allow get: if false;
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Grants or denies access to audit documents.
     * @path /audit/{auditId}
     * @allow (create) - No user can create audit logs.
     * @allow (get, list, update, delete) - No user can get, list, update or delete audit logs.
     * @principle Denies all access.
     */
    match /audit/{auditId} {
      allow get: if false;
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Grants or denies access to theme settings.
     * @path /settings/theme
     * @allow (get, list, create, update, delete) - Any user can read and write theme settings.
     * @principle Allows public access.
     */
    match /settings/theme {
      allow get: if true;
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Grants or denies access to legacy subscription documents.
     * @path /teacher_subscriptions/{id}
     * @allow (create) - No user can create teacher subscription details.
     * @allow (get, list, update, delete) - No user can get, list, update or delete teacher subscription details.
     * @principle Denies all access.
     */
    match /teacher_subscriptions/{id} {
      allow get: if false;
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Grants or denies access to subscription plan documents.
     * @path /subscription_plans/{planId}
     * @allow (get, list) - Any user can read subscription plan details.
     * @deny (create, update, delete) - No user can create, update, or delete subscription plan details.
     * @principle Allows public read access.
     */
    match /subscription_plans/{planId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}