/**
 * @file Firebase Security Rules for iLearn Platform
 *
 * @core_philosophy This ruleset enforces a role-based access control model with user and organization ownership.
 *  It leverages denormalization to avoid complex queries and ensure efficient authorization checks.
 *
 * @data_structure
 * - /organizations/{orgId}: Stores organization-wide data. Accessible only by authorized users within the organization.
 * - /users/{userId}: Stores user-specific data. Access is restricted to the user and organization administrators.
 * - Other top-level collections: Resources like classes, playlists, and videos, are secured using the `orgId` to verify organizational membership.
 *
 * @key_security_decisions
 * - Listing all users is disallowed for security reasons, as it could expose sensitive information.
 * - Read access to most collections is generally open, but write access is strictly controlled based on roles and ownership.
 * - The `orgId` field is crucial for scoping data access within an organization.
 * - Subscription plans are only manageable by admins.
 *
 * @denormalization_for_authorization
 * - The `orgId` field is duplicated across many collections to enable efficient organization-level access control.
 * - The `userId` field is duplicated in the `teacher_subscriptions` collection to allow rules to directly control access to teacher subscription records.
 *
 * @structural_segregation There are no explicitly public/private data scenarios requiring segregation in this model,
 * so public top-level collections are generally used.  `list` operations must be secured via `orgId` to prevent unauthorized data access.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     * @path N/A
     * @allow N/A
     * @deny N/A
     * @principle Validates user authentication
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user's ID matches the provided user ID.
     * @path N/A
     * @allow N/A
     * @deny N/A
     * @principle Enforces user-specific data access
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user's ID matches the resource's user ID and that the resource exists.
     * @path N/A
     * @allow N/A
     * @deny N/A
     * @principle Enforces user-specific data access and existence
     */
    function isExistingOwner(userId) {
        return (isOwner(userId) && exists(/databases/$(database)/documents/users/$(userId)));
    }

    /**
     * @description Checks if the authenticated user has the 'admin' role.
     * @path N/A
     * @allow N/A
     * @deny N/A
     */
    function isAdmin() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    /**
     * @description Checks if the authenticated user has the 'teacher' role.
     * @path N/A
     * @allow N/A
     * @deny N/A
     */
    function isTeacher() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'teacher';
    }

    /**
     * @description Validates the organization ID against the resource data.
     * @path N/A
     * @allow N/A
     * @deny N/A
     * @principle Enforces organizational data access
     */
    function orgIdMatches(orgId) {
        return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.orgId == orgId;
    }

    /**
     * @description Checks if the authenticated user is part of the organization associated with the resource.
     * @path N/A
     * @allow N/A
     * @deny N/A
     * @principle Enforces organizational data access based on orgId.
     */
    function isInOrganization(orgId) {
      return isSignedIn() && orgIdMatches(orgId);
    }


    /**
     * @description Defines access rules for the /organizations/{orgId} collection.
     * @path /organizations/{orgId}
     * @allow (get) User with orgId can read the data.
     * @allow (create) User with orgId can create the data if orgId matches
     * @deny (update) User without correct orgId cannot update the data
     * @deny (delete) Non-admin user cannot delete data.
     * @principle Enforces organization-level access control.
     */
    match /organizations/{orgId} {
      allow get: if isInOrganization(orgId);
      allow list: if false;
      allow create: if isSignedIn() && request.resource.data.id == orgId;
      allow update: if isInOrganization(orgId) && request.resource.data.id == orgId;
      allow delete: if isAdmin();
    }

    /**
     * @description Defines access rules for the /users/{userId} collection.
     * @path /users/{userId}
     * @allow (get) User can read their own data.
     * @allow (create) User can create their own data if userId matches.
     * @deny (update) User cannot update other user's data.
     * @deny (delete) Non-admin user cannot delete other user's data.
     * @principle Enforces user-specific data access.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false; // Listing all users is prohibited.
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isAdmin();
    }

    /**
     * @description Defines access rules for the /classes/{classId} collection.
     * @path /classes/{classId}
     * @allow (get) User in the organization can read the class data.
     * @allow (create) User in the organization can create a class.
     * @deny (update) User not in the organization cannot update the class.
     * @deny (delete) Non-admin user cannot delete a class.
     * @principle Enforces organization-level access control for classes.
     */
    match /classes/{classId} {
      allow get: if isInOrganization(resource.data.orgId);
      allow list: if isInOrganization(resource.data.orgId);
      allow create: if isSignedIn() && isInOrganization(request.resource.data.orgId);
      allow update: if isInOrganization(resource.data.orgId);
      allow delete: if isAdmin();
    }

    /**
     * @description Defines access rules for the /playlists/{playlistId} collection.
     * @path /playlists/{playlistId}
     * @allow (get) User in the organization can read the playlist.
     * @allow (create) User in the organization can create a playlist.
     * @deny (update) User not in the organization cannot update the playlist.
     * @deny (delete) Non-admin user cannot delete the playlist.
     * @principle Enforces organization-level access control for playlists.
     */
    match /playlists/{playlistId} {
      allow get: if isInOrganization(resource.data.orgId);
      allow list: if isInOrganization(resource.data.orgId);
      allow create: if isSignedIn() && isInOrganization(request.resource.data.orgId);
      allow update: if isInOrganization(resource.data.orgId);
      allow delete: if isAdmin();
    }

    /**
     * @description Defines access rules for the /videos/{videoId} collection.
     * @path /videos/{videoId}
     * @allow (get) Any user can read video data.
     * @allow (create) User in the organization can create a video.
     * @deny (update) User not in the organization cannot update the video.
     * @deny (delete) Non-admin user cannot delete the video.
     * @principle Enforces organization-level access control for videos.
     */
    match /videos/{videoId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn() && isInOrganization(request.resource.data.orgId);
      allow update: if isInOrganization(resource.data.orgId);
      allow delete: if isAdmin();
    }

    /**
     * @description Defines access rules for the /videos/{videoId}/segments/{segmentId} collection.
     * @path /videos/{videoId}/segments/{segmentId}
     * @allow (get) Any user can read segment data.
     * @allow (create) User in the organization can create a segment.
     * @deny (update) User not in the organization cannot update the segment.
     * @deny (delete) Non-admin user cannot delete the segment.
     * @principle Enforces organization-level access control for video segments.
     */
    match /videos/{videoId}/segments/{segmentId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn() && isInOrganization(request.resource.data.orgId);
      allow update: if isInOrganization(resource.data.orgId);
      allow delete: if isAdmin();
    }

    /**
     * @description Defines access rules for the /videos/{videoId}/segments/{segmentId}/questions/{questionId} collection.
     * @path /videos/{videoId}/segments/{segmentId}/questions/{questionId}
     * @allow (get) Any user can read question data.
     * @allow (create) User in the organization can create a question.
     * @deny (update) User not in the organization cannot update the question.
     * @deny (delete) Non-admin user cannot delete the question.
     * @principle Enforces organization-level access control for questions.
     */
    match /videos/{videoId}/segments/{segmentId}/questions/{questionId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn() && isInOrganization(request.resource.data.orgId);
      allow update: if isInOrganization(resource.data.orgId);
      allow delete: if isAdmin();
    }

    /**
     * @description Defines access rules for the /assignments/{assignmentId} collection.
     * @path /assignments/{assignmentId}
     * @allow (get) User in the organization can read the assignment.
     * @allow (create) User in the organization can create an assignment.
     * @deny (update) User not in the organization cannot update the assignment.
     * @deny (delete) Non-admin user cannot delete the assignment.
     * @principle Enforces organization-level access control for assignments.
     */
    match /assignments/{assignmentId} {
      allow get: if isInOrganization(resource.data.orgId);
      allow list: if isInOrganization(resource.data.orgId);
      allow create: if isSignedIn() && isInOrganization(request.resource.data.orgId);
      allow update: if isInOrganization(resource.data.orgId);
      allow delete: if isAdmin();
    }

    /**
     * @description Defines access rules for the /progress/{progressId} collection.
     * @path /progress/{progressId}
     * @allow (get) User can read the progress if they are the owner.
     * @allow (create) User can create progress record.
     * @deny (update) User cannot update progress record if not the owner.
     * @deny (delete) User cannot delete progress record if not the owner.
     * @principle Enforces user-specific access control for progress.
     */
    match /progress/{progressId} {
      allow get: if isOwner(resource.data.userId);
      allow list: if false;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid; // Ownership established by userId in data.
      allow update: if isOwner(resource.data.userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isOwner(resource.data.userId);
    }

    /**
     * @description Defines access rules for the /attempts/{attemptId} collection.
     * @path /attempts/{attemptId}
     * @allow (get) User can read the attempt if they are the owner.
     * @allow (create) User can create attempt record.
     * @deny (update) User cannot update attempt record if not the owner.
     * @deny (delete) User cannot delete attempt record if not the owner.
     * @principle Enforces user-specific access control for attempts.
     */
    match /attempts/{attemptId} {
      allow get: if isOwner(resource.data.userId);
      allow list: if false;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid; // Ownership established by userId in data.
      allow update: if isOwner(resource.data.userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isOwner(resource.data.userId);
    }

    /**
     * @description Defines access rules for the /subscription_plans/{subscriptionPlanId} collection.
     * @path /subscription_plans/{subscriptionPlanId}
     * @allow (get) Any user can read subscription plan data.
     * @allow (create) Only admin can create subscription plans.
     * @deny (update) Non-admin user cannot update subscription plans.
     * @deny (delete) Non-admin user cannot delete subscription plans.
     * @principle Enforces admin-level access control for subscription plans.
     */
    match /subscription_plans/{subscriptionPlanId} {
      allow get: if true;
      allow list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Defines access rules for the /teacher_subscriptions/{teacherSubscriptionId} collection.
     * @path /teacher_subscriptions/{teacherSubscriptionId}
     * @allow (get) User (teacher) can read the subscription if they are the owner.
     * @allow (create) User (teacher) can create a subscription for themself.
     * @deny (update) Non-admin and non-owner user cannot update teacher subscriptions.
     * @deny (delete) Non-admin user cannot delete teacher subscriptions.
     * @principle Enforces user-specific access control for teacher subscriptions.
     */
    match /teacher_subscriptions/{teacherSubscriptionId} {
      allow get: if isOwner(resource.data.userId) || isAdmin();
      allow list: if false;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if (isOwner(resource.data.userId) || isAdmin()) && request.resource.data.userId == resource.data.userId;
      allow delete: if isAdmin();
    }
  }
}