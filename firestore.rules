/**
 * @fileoverview Firestore Security Rules for the application.
 *
 * Core Philosophy:
 * This ruleset prioritizes security by enforcing strict ownership and role-based access control.
 * It assumes a multi-tenant architecture where coaches (tenants) own data and users have roles within those tenants.
 * Data access is generally restricted to authorized users within their respective coach contexts, with exceptions for public data.
 *
 * Data Structure:
 * - /coaches/{coachId}: Stores coach-specific data. Coaches are the top-level tenants.
 * - /users/{userId}: Stores user data. Each user belongs to a coach.
 * - /plans/{planId}: Stores global subscription plan data.
 * - /subscriptions/{subId}: Stores subscription data for each coach.
 * - /payments/{paymentId}: Stores payment records, linked to coaches.
 * - /invoices/{invoiceId}: Stores invoice data for coaches.
 * - /audit/{auditId}: Stores audit logs.
 * - /settings/theme: Stores global theme settings.
 * - /teacher_subscriptions/{id}: Stores legacy subscription data.
 * - /subscription_plans/{planId}: Stores subscription plan details, publicly accessible.
 *
 * Key Security Decisions:
 * - User listing is generally disallowed to prevent information leakage.
 * - The /subscription_plans collection is explicitly made public for read access to support the landing page.
 * - Data validation is limited to authorization-critical fields in this prototyping phase.
 *
 * Denormalization for Authorization:
 * - Coach membership is denormalized onto the User document via the `coachId` field,
 *   enabling rules to quickly verify if a user belongs to a specific coach.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user's ID matches the provided user ID.
     * @param {string} userId - The user ID to compare against.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the user is an existing owner of the document.  Combines ownership check with existence check.
     * @param {string} userId - The user ID to compare against.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Allows anyone to read subscription plans.
     * @path /subscription_plans/{planId}
     * @allow (list) - Any user can list subscription plans.
     * @allow (get) - Any user can get a specific subscription plan.
     * @deny (create) - No one can create subscription plans through client-side rules.
     */
    match /subscription_plans/{planId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Manages access to coach data.
     * @path /coaches/{coachId}
     * @allow (create) - Only the coach themselves can create their record.
     * @allow (get) - Any authenticated user can read a coach's data.
     * @allow (update) - Only the coach themselves can update their record.
     * @allow (delete) - Only the coach themselves can delete their record.
     * @deny (create) - If the coach id does not match the auth user id.
     * @deny (update) - If the coach id does not match the auth user id.
     * @principle Enforces document ownership for writes and allows public reads.
     */
    match /coaches/{coachId} {
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if isOwner(coachId);
      allow update: if isExistingOwner(coachId);
      allow delete: if isExistingOwner(coachId);
    }

    /**
     * @description Manages access to user data.
     * @path /users/{userId}
     * @allow (create) - A user can create their own record (self-registration).
     * @allow (get) - Only the user themselves can read their own data.
     * @allow (update) - Only the user themselves can update their own data.
     * @allow (delete) - Only the user themselves can delete their own data.
     * @deny (create) - If the user id does not match the auth user id.
     * @deny (update) - If the user id does not match the auth user id.
     * @principle Enforces strict user-ownership for all operations.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Manages access to plan data.
     * @path /plans/{planId}
     * @allow (get) - Any authenticated user can read plan data.
     * @allow (list) - Any authenticated user can list plan data.
     * @deny (create) - No one can create, update, or delete plans via client-side rules.
     */
    match /plans/{planId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if false;
    }

    /**
     * @description Manages access to subscription data.
     * @path /subscriptions/{subId}
     * @allow (get) - Any authenticated user can read subscription data.
     * @allow (list) - Any authenticated user can list subscription data.
     * @deny (create) - No one can create, update, or delete subscriptions via client-side rules.
     */
    match /subscriptions/{subId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if false;
    }

    /**
     * @description Manages access to payment data.
     * @path /payments/{paymentId}
     * @allow (get) - Any authenticated user can read payment data.
     * @allow (list) - Any authenticated user can list payment data.
     * @deny (create) - No one can create, update, or delete payments via client-side rules.
     */
    match /payments/{paymentId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if false;
    }

    /**
     * @description Manages access to invoice data.
     * @path /invoices/{invoiceId}
     * @allow (get) - Any authenticated user can read invoice data.
     * @allow (list) - Any authenticated user can list invoice data.
     * @deny (create) - No one can create, update, or delete invoices via client-side rules.
     */
    match /invoices/{invoiceId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if false;
    }

    /**
     * @description Manages access to audit data.
     * @path /audit/{auditId}
     * @allow (get) - Any authenticated user can read audit data.
     * @allow (list) - Any authenticated user can list audit data.
     * @deny (create) - No one can create, update, or delete audit entries via client-side rules.
     */
    match /audit/{auditId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if false;
    }

    /**
     * @description Manages access to theme settings.
     * @path /settings/theme
     * @allow (get) - Any authenticated user can read theme settings.
     * @deny (list) - Listing is not allowed
     * @deny (create, update, delete) - No one can create, update or delete theme settings via client-side rules.
     */
    match /settings/theme {
      allow get: if isSignedIn();
      allow list: if false;
      allow create, update, delete: if false;
    }

    /**
     * @description Manages access to teacher subscription data (legacy).
     * @path /teacher_subscriptions/{id}
     * @allow (get) - Any authenticated user can read teacher subscription data.
     * @allow (list) - Any authenticated user can list teacher subscription data.
     * @deny (create) - No one can create, update, or delete teacher subscriptions via client-side rules.
     */
    match /teacher_subscriptions/{id} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if false;
    }
  }
}