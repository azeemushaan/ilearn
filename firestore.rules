/**
 * @fileoverview Firestore Security Rules
 *
 * Core Philosophy:
 * This ruleset prioritizes security by enforcing strict access control based on
 * user roles and resource ownership. Data validation is relaxed to facilitate
 * rapid prototyping, but authorization checks are robust.
 *
 * Data Structure:
 * The Firestore data is organized around a multi-tenant model. Coaches are the
 * top-level tenants, and most data is scoped to a specific coachId. User
 * documents are stored in a top-level /users collection and linked to coaches
 * via the coachId field.
 *
 * Key Security Decisions:
 * - Listing of users is generally disallowed to prevent information disclosure.
 * - Coaches and Users are granted create permissions only if they are signed in.
 * - Data validation is minimized in favor of rapid prototyping. However,
 *   authorization-critical fields (e.g., ownership fields) are strictly validated.
 * - Access control is implemented using helper functions to improve readability
 *   and maintainability.
 *
 * Denormalization for Authorization:
 * Several collections rely on denormalization to simplify and optimize security rules.
 * For example:
 *   - Many documents include a `coachId` field, allowing rules to quickly check
 *     if the requesting user belongs to the correct tenant.
 *
 * Structural Segregation:
 * This ruleset does not implement any structural segregation.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the user ID matches the authenticated user's ID.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the user ID matches the existing resource's coachId.
     */
    function isCoach(coachId) {
      return request.auth.uid == coachId;
    }

    /**
     * @description Checks if the user is deleting or updating their own resource.
     */
    function isExistingOwner(userId) {
        return isSignedIn() && request.auth.uid == resource.data.userId;
    }

    /**
     * @description Determines if the user is the coach of a resource, for destructive changes.
     */
    function isExistingCoach(coachId) {
      return isSignedIn() && request.auth.uid == resource.data.coachId;
    }

    /**
     * @description Checks if the user has the 'admin' role.
     */
    function isAdmin() {
      return request.auth.token.role == 'admin';
    }

    /**
     * @description Checks if the user is a teacher.
     */
    function isTeacher() {
        return request.auth.token.role == 'teacher';
    }

    /**
     * @description Checks if the user is a student.
     */
    function isStudent() {
        return request.auth.token.role == 'student';
    }
    
    match /coaches/{coachId} {
      /**
       * @description Allows coaches to manage their own profiles.
       * @path /coaches/{coachId}
       * @allow (create) User with matching UID creates their coach profile.
       * @deny (update) User attempts to update a coach profile with a mismatched UID.
       * @principle Enforces document ownership for writes.
       */
      allow get: if isSignedIn() && request.auth.uid == coachId;
      allow list: if false;
      allow create: if isSignedIn() && request.auth.uid == coachId;
      allow update: if isSignedIn() && request.auth.uid == coachId;
      allow delete: if isSignedIn() && request.auth.uid == coachId;
    }

    match /users/{userId} {
      /**
       * @description Allows users to manage their own profiles.
       * @path /users/{userId}
       * @allow (create) User with matching UID creates their user profile.
       * @deny (update) User attempts to update a user profile with a mismatched UID.
       * @principle Enforces document ownership for writes.
       */
      allow get: if isSignedIn() && request.auth.uid == userId;
      allow list: if false;
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isSignedIn() && request.auth.uid == userId;
      allow delete: if isSignedIn() && request.auth.uid == userId;
    }

    match /invites/{inviteId} {
      /**
       * @description Allows invite management.  No specific authorization implemented yet.
       * @path /invites/{inviteId}
       * @allow (create) Anyone can create invites.
       * @deny (update) Nobody can update invites.
       * @principle Placeholder rule.
       */
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    match /cohorts/{cohortId} {
      /**
       * @description Allows cohort management.  No specific authorization implemented yet.
       * @path /cohorts/{cohortId}
       * @allow (create) Anyone can create cohorts.
       * @deny (update) Nobody can update cohorts.
       * @principle Placeholder rule.
       */
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    match /cohorts/{cohortId}/members/{userId} {
      /**
       * @description Allows cohort member management.  No specific authorization implemented yet.
       * @path /cohorts/{cohortId}/members/{userId}
       * @allow (create) Anyone can create cohort members.
       * @deny (update) Nobody can update cohort members.
       * @principle Placeholder rule.
       */
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    match /playlists/{playlistId} {
      /**
       * @description Allows playlist management.  No specific authorization implemented yet.
       * @path /playlists/{playlistId}
       * @allow (create) Anyone can create playlists.
       * @deny (update) Nobody can update playlists.
       * @principle Placeholder rule.
       */
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    match /videos/{videoId} {
      /**
       * @description Allows video management.  No specific authorization implemented yet.
       * @path /videos/{videoId}
       * @allow (create) Anyone can create videos.
       * @deny (update) Nobody can update videos.
       * @principle Placeholder rule.
       */
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    match /videos/{videoId}/segments/{segmentId} {
      /**
       * @description Allows segment management.  No specific authorization implemented yet.
       * @path /videos/{videoId}/segments/{segmentId}
       * @allow (create) Anyone can create segments.
       * @deny (update) Nobody can update segments.
       * @principle Placeholder rule.
       */
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    match /videos/{videoId}/segments/{segmentId}/questions/{questionId} {
      /**
       * @description Allows question management.  No specific authorization implemented yet.
       * @path /videos/{videoId}/segments/{segmentId}/questions/{questionId}
       * @allow (create) Anyone can create questions.
       * @deny (update) Nobody can update questions.
       * @principle Placeholder rule.
       */
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    match /assignments/{assignmentId} {
      /**
       * @description Allows assignment management.  No specific authorization implemented yet.
       * @path /assignments/{assignmentId}
       * @allow (create) Anyone can create assignments.
       * @deny (update) Nobody can update assignments.
       * @principle Placeholder rule.
       */
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    match /enrollments/{enrollmentId} {
      /**
       * @description Allows enrollment management.  No specific authorization implemented yet.
       * @path /enrollments/{enrollmentId}
       * @allow (create) Anyone can create enrollments.
       * @deny (update) Nobody can update enrollments.
       * @principle Placeholder rule.
       */
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    match /attempts/{attemptId} {
      /**
       * @description Allows attempt management.  No specific authorization implemented yet.
       * @path /attempts/{attemptId}
       * @allow (create) Anyone can create attempts.
       * @deny (update) Nobody can update attempts.
       * @principle Placeholder rule.
       */
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    match /progress/{progressId} {
      /**
       * @description Allows progress management.  No specific authorization implemented yet.
       * @path /progress/{progressId}
       * @allow (create) Anyone can create progress records.
       * @deny (update) Nobody can update progress records.
       * @principle Placeholder rule.
       */
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    match /events/{eventId} {
      /**
       * @description Allows event logging.  No specific authorization implemented yet.
       * @path /events/{eventId}
       * @allow (create) Anyone can create events.
       * @deny (update) Nobody can update events.
       * @principle Placeholder rule.
       */
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    match /notes/{noteId} {
      /**
       * @description Allows note taking.  No specific authorization implemented yet.
       * @path /notes/{noteId}
       * @allow (create) Anyone can create notes.
       * @deny (update) Nobody can update notes.
       * @principle Placeholder rule.
       */
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    match /certificates/{certificateId} {
      /**
       * @description Allows certificate issuance.  No specific authorization implemented yet.
       * @path /certificates/{certificateId}
       * @allow (create) Anyone can create certificates.
       * @deny (update) Nobody can update certificates.
       * @principle Placeholder rule.
       */
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    match /resources/{resourceId} {
      /**
       * @description Allows resource management.  No specific authorization implemented yet.
       * @path /resources/{resourceId}
       * @allow (create) Anyone can create resources.
       * @deny (update) Nobody can update resources.
       * @principle Placeholder rule.
       */
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    match /subscriptions/{subId} {
      /**
       * @description Allows subscription management.  No specific authorization implemented yet.
       * @path /subscriptions/{subId}
       * @allow (create) Anyone can create subscriptions.
       * @deny (update) Nobody can update subscriptions.
       * @principle Placeholder rule.
       */
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    match /payments/{paymentId} {
      /**
       * @description Allows payment tracking.  No specific authorization implemented yet.
       * @path /payments/{paymentId}
       * @allow (create) Anyone can create payments.
       * @deny (update) Nobody can update payments.
       * @principle Placeholder rule.
       */
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    match /audit/{auditId} {
      /**
       * @description Allows audit logging.  No specific authorization implemented yet.
       * @path /audit/{auditId}
       * @allow (create) Anyone can create audit entries.
       * @deny (update) Nobody can update audit entries.
       * @principle Placeholder rule.
       */
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    match /settings/{coachId} {
      /**
       * @description Allows settings retrieval for a coach.
       * @path /settings/{coachId}
       * @allow (get) Anyone can retrieve settings for a coach.
       * @deny (update) Nobody can update settings directly.
       * @principle Public read, no writes allowed.
       */
      allow get: if isSignedIn() && request.auth.uid == coachId;
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
    
    match /subscription_plans/{subPlanId} {
        /**
         * @description Allows public listing and reading of subscription plans.
         * @path /subscription_plans/{subPlanId}
         * @allow (get, list) Anyone can retrieve a list or individual subscription plan.
         * @deny (create, update, delete) No one can modify subscription plans through the client.
         * @principle Public read, no writes allowed.
         */
        allow get: if true;
        allow list: if true;
        allow create: if false;
        allow update: if false;
        allow delete: if false;
    }
  }
}