/**
 * @fileOverview Firestore Security Rules for the iLearn platform.
 *
 * Core Philosophy:
 * This ruleset enforces a user-ownership and role-based access control model. Most data is scoped to an organization, and users can only access data within their organization. Teachers have additional privileges within their classes. Administrative access is granted based on the 'role' field in the user document.
 *
 * Data Structure:
 * The Firestore database is organized as follows:
 * - /organizations/{orgId}: Stores organization details.
 * - /users/{userId}: Stores user details, including role and orgId.
 * - /classes/{classId}: Stores class details, including orgId and teacherIds.
 * - /playlists/{playlistId}: Stores playlist details, including orgId and classIds.
 * - /videos/{videoId}: Stores video details, including orgId.
 * - /videos/{videoId}/segments/{segmentId}: Stores video segments.
 * - /videos/{videoId}/segments/{segmentId}/questions/{questionId}: Stores questions for video segments.
 * - /assignments/{assignmentId}: Stores assignment details, including orgId, playlistId, and classId.
 * - /progress/{progressId}: Stores student progress on assignments.
 * - /attempts/{attemptId}: Stores student attempts to answer questions.
 * - /subscription_plans/{subscriptionPlanId}: Stores subscription plan details (admin-only).
 * - /teacher_subscriptions/{teacherSubscriptionId}: Stores teacher subscriptions.
 * - /settings/theme: Stores the theme settings (publicly readable).
 *
 * Key Security Decisions:
 * - Strict ownership for user-related data: Users can only access their own user document.
 * - Organization-scoped access: Most data is scoped to an organization, and users can only access data within their organization.
 * - Role-based access: Admins have additional privileges, such as creating subscription plans.
 * - Public read access for settings: The /settings/theme document is publicly readable.
 * - Listing of user documents is disallowed for privacy reasons.
 *
 * Denormalization for Authorization:
 * The `orgId` field is present on almost every collection to avoid costly `get()` operations. The `User` document contains `role` information to avoid separate role lookups.
 * TeacherSubscription includes the `userId` for simpler rule-based access.
 *
 * Structural Segregation:
 * Private user data and public settings data are stored in separate collections to simplify access control and improve performance.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows anyone to read the theme settings.
     * @path /settings/theme
     * @allow get, list: if true
     * @deny create, update, delete: if false
     * @principle Allows public read access to the theme settings.
     */
    match /settings/theme {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Manages access to organization data.
     * @path /organizations/{orgId}
     * @allow get: if isSignedIn()
     * @allow create: if false
     * @allow update: if false
     * @allow delete: if false
     * @allow list: if false
     * @principle Restricts write access to organizations.
     */
    match /organizations/{orgId} {
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Manages access to user data.
     * @path /users/{userId}
     * @allow get: if isOwner(userId)
     * @allow create: if isSelfCreation(userId)
     * @allow update: if isExistingOwner(userId)
     * @allow delete: if false
     * @allow list: if false
     * @principle Enforces document ownership for user data.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isSelfCreation(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if false;
    }

    /**
     * @description Manages access to class data.
     * @path /classes/{classId}
     * @allow get: if isSignedIn()
     * @allow create: if false
     * @allow update: if false
     * @allow delete: if false
     * @allow list: if isSignedIn()
     * @principle Requires user to be signed in for read access.
     */
    match /classes/{classId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Manages access to playlist data.
     * @path /playlists/{playlistId}
     * @allow get: if isSignedIn()
     * @allow create: if false
     * @allow update: if false
     * @allow delete: if false
     * @allow list: if isSignedIn()
     * @principle Requires user to be signed in for read access.
     */
    match /playlists/{playlistId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Manages access to video data.
     * @path /videos/{videoId}
     * @allow get: if isSignedIn()
     * @allow create: if false
     * @allow update: if false
     * @allow delete: if false
     * @allow list: if isSignedIn()
     * @principle Requires user to be signed in for read access.
     */
    match /videos/{videoId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Manages access to segment data within a video.
     * @path /videos/{videoId}/segments/{segmentId}
     * @allow get: if isSignedIn()
     * @allow create: if false
     * @allow update: if false
     * @allow delete: if false
     * @allow list: if isSignedIn()
     * @principle Requires user to be signed in for read access.
     */
    match /videos/{videoId}/segments/{segmentId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Manages access to question data within a video segment.
     * @path /videos/{videoId}/segments/{segmentId}/questions/{questionId}
     * @allow get: if isSignedIn()
     * @allow create: if false
     * @allow update: if false
     * @allow delete: if false
     * @allow list: if isSignedIn()
     * @principle Requires user to be signed in for read access.
     */
    match /videos/{videoId}/segments/{segmentId}/questions/{questionId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Manages access to assignment data.
     * @path /assignments/{assignmentId}
     * @allow get: if isSignedIn()
     * @allow create: if false
     * @allow update: if false
     * @allow delete: if false
     * @allow list: if isSignedIn()
     * @principle Requires user to be signed in for read access.
     */
    match /assignments/{assignmentId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Manages access to progress data.
     * @path /progress/{progressId}
     * @allow get: if isSignedIn()
     * @allow create: if false
     * @allow update: if false
     * @allow delete: if false
     * @allow list: if isSignedIn()
     * @principle Requires user to be signed in for read access.
     */
    match /progress/{progressId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Manages access to attempt data.
     * @path /attempts/{attemptId}
     * @allow get: if isSignedIn()
     * @allow create: if false
     * @allow update: if false
     * @allow delete: if false
     * @allow list: if isSignedIn()
     * @principle Requires user to be signed in for read access.
     */
    match /attempts/{attemptId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

   /**
     * @description Manages access to subscription plan data.
     * @path /subscription_plans/{subscriptionPlanId}
     * @allow get: if isSignedIn()
     * @allow create: if false
     * @allow update: if false
     * @allow delete: if false
     * @allow list: if isSignedIn()
     */
    match /subscription_plans/{subscriptionPlanId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Manages access to teacher subscription data.
     * @path /teacher_subscriptions/{teacherSubscriptionId}
     * @allow get: if isTeacherSubscriptionOwner()
     * @allow create: if false
     * @allow update: if false
     * @allow delete: if false
     * @allow list: if isSignedIn()
     * @principle Restricts write access and allows read access to the owner.
     */
    match /teacher_subscriptions/{teacherSubscriptionId} {
      allow get: if isTeacherSubscriptionOwner();
      allow list: if isSignedIn();
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    // ----- Helper functions -----

    /**
     * @description Checks if the user is signed in.
     * @return {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the user is the owner of the document.
     * @param {string} userId - The user ID to check.
     * @return {boolean} True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the user is creating their own user document.
     * @param {string} userId - The user ID to check.
     * @return {boolean} True if the user is creating their own document, false otherwise.
     */
    function isSelfCreation(userId) {
        return isSignedIn() && request.auth.uid == userId && request.resource.data.id == userId;
    }

    /**
     * @description Checks if the user is the owner of an existing document.
     * @param {string} userId - The user ID to check.
     * @return {boolean} True if the user is the owner and the document exists, false otherwise.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Checks if the authenticated user is the owner of the teacher subscription.
     *  This rule checks the denormalized `userId` field on the `teacher_subscriptions` document against the `request.auth.uid`.
     * @return {boolean} True if the user owns the subscription, false otherwise.
     */
    function isTeacherSubscriptionOwner() {
      return isSignedIn() && request.auth.uid == resource.data.userId;
    }
  }
}