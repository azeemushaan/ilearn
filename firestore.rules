/**
 * @file iLearn Firestore Security Rules
 * @version 2
 *
 * @Core Philosophy
 * This ruleset enforces a multi-tenant security model where data access is primarily scoped to the organization (orgId).
 * Users are authorized based on their role within the organization.
 * The rules leverage denormalization to avoid expensive `get()` calls and ensure authorization independence.
 *
 * @Data Structure
 * The Firestore database is organized as a flat collection of top-level collections:
 * - /organizations/{orgId}: Organization details.
 * - /users/{userId}: User details, including orgId and role.
 * - /classes/{classId}: Class details, including orgId and teacherIds.
 * - /playlists/{playlistId}: Playlist details, including orgId and classIds.
 * - /videos/{videoId}: Video details, including orgId.
 * - /videos/{videoId}/segments/{segmentId}: Segment details for a video.
 * - /videos/{videoId}/segments/{segmentId}/questions/{questionId}: Question details for a video segment.
 * - /assignments/{assignmentId}: Assignment details, including orgId, playlistId, and classId.
 * - /progress/{progressId}: Student progress for an assignment.
 * - /attempts/{attemptId}: Student attempts to answer questions.
 * - /subscription_plans/{subscriptionPlanId}: Subscription plan details.
 * - /teacher_subscriptions/{teacherSubscriptionId}: Teacher subscriptions to specific plans.
 *
 * @Key Security Decisions
 * - **No User Listing**: Listing the `/users` collection is not permitted to prevent unauthorized access to user information.
 * - **Organization-Based Access**: Most collections are scoped to an `orgId`, ensuring that users can only access data within their organization.
 * - **Ownership-Based Access**: `create`, `update`, and `delete` operations require authentication.
 * - **Admin Roles**: The `users` collection stores the `role` field for each user, including admins, used to grant admin-level access.
 * - **Teacher Subscriptions**: Access to `/teacher_subscriptions` is controlled through the denormalized `userId` field.
 * - **Write operations**: are protected by an authorization check
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows read and write access to organization documents.
     * @path /organizations/{orgId}
     * @allow (get, list) if true (Public read access)
     * @allow (create) if isSignedIn() && request.resource.data.id == request.auth.uid (Authenticated user can create)
     * @allow (update, delete) if isSignedIn() && resource.data.id == request.auth.uid (Authenticated user can update/delete)
     * @deny (create, update, delete) if !isSignedIn() (Unauthenticated cannot write)
     * @principle Allows anyone to read organization details; authenticated user can create, update, and delete
     */
    match /organizations/{orgId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.id == request.auth.uid;
      allow update, delete: if isSignedIn() && resource.data.id == request.auth.uid && resource != null;
    }

    /**
     * @description Allows read and write access to user documents.
     * @path /users/{userId}
     * @allow (get) if isSignedIn() && request.auth.uid == userId (User can read their own profile)
     * @deny (create, list, update, delete) if true (Users cannot be created, listed, updated, or deleted through the API)
     * @principle Restricts user management to backend services.
     */
    match /users/{userId} {
      allow get: if isSignedIn() && request.auth.uid == userId;
      allow list, create, update, delete: if false;
    }

    /**
     * @description Allows read and write access to class documents.
     * @path /classes/{classId}
     * @allow (get, list) if true (Public read access)
     * @allow (create) if isSignedIn() && request.resource.data.orgId != null (Authenticated user can create)
     * @allow (update, delete) if isSignedIn() && resource.data.orgId != null && resource != null (Authenticated user can update/delete)
     * @deny (create, update, delete) if !isSignedIn() (Unauthenticated cannot write)
     * @principle Allows anyone to read class details; authenticated user can create, update, and delete
     */
    match /classes/{classId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.orgId != null;
      allow update, delete: if isSignedIn() && resource.data.orgId != null && resource != null;
    }

    /**
     * @description Allows read and write access to playlist documents.
     * @path /playlists/{playlistId}
     * @allow (get, list) if true (Public read access)
     * @allow (create) if isSignedIn() && request.resource.data.orgId != null (Authenticated user can create)
     * @allow (update, delete) if isSignedIn() && resource.data.orgId != null && resource != null (Authenticated user can update/delete)
     * @deny (create, update, delete) if !isSignedIn() (Unauthenticated cannot write)
     * @principle Allows anyone to read playlist details; authenticated user can create, update, and delete
     */
    match /playlists/{playlistId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.orgId != null;
      allow update, delete: if isSignedIn() && resource.data.orgId != null && resource != null;
    }

    /**
     * @description Allows read and write access to video documents.
     * @path /videos/{videoId}
     * @allow (get, list) if true (Public read access)
     * @allow (create) if isSignedIn() && request.resource.data.orgId != null (Authenticated user can create)
     * @allow (update, delete) if isSignedIn() && resource.data.orgId != null && resource != null (Authenticated user can update/delete)
     * @deny (create, update, delete) if !isSignedIn() (Unauthenticated cannot write)
     * @principle Allows anyone to read video details; authenticated user can create, update, and delete
     */
    match /videos/{videoId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.orgId != null;
      allow update, delete: if isSignedIn() && resource.data.orgId != null && resource != null;
    }

    /**
     * @description Allows read and write access to segment documents.
     * @path /videos/{videoId}/segments/{segmentId}
     * @allow (get, list) if true (Public read access)
     * @allow (create) if isSignedIn() (Authenticated user can create)
     * @allow (update, delete) if isSignedIn() && resource != null (Authenticated user can update/delete)
     * @deny (create, update, delete) if !isSignedIn() (Unauthenticated cannot write)
     * @principle Allows anyone to read segment details; authenticated user can create, update, and delete
     */
    match /videos/{videoId}/segments/{segmentId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update, delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Allows read and write access to question documents.
     * @path /videos/{videoId}/segments/{segmentId}/questions/{questionId}
     * @allow (get, list) if true (Public read access)
     * @allow (create) if isSignedIn() (Authenticated user can create)
     * @allow (update, delete) if isSignedIn() && resource != null (Authenticated user can update/delete)
     * @deny (create, update, delete) if !isSignedIn() (Unauthenticated cannot write)
     * @principle Allows anyone to read question details; authenticated user can create, update, and delete
     */
    match /videos/{videoId}/segments/{segmentId}/questions/{questionId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update, delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Allows read and write access to assignment documents.
     * @path /assignments/{assignmentId}
     * @allow (get, list) if true (Public read access)
     * @allow (create) if isSignedIn() && request.resource.data.orgId != null (Authenticated user can create)
     * @allow (update, delete) if isSignedIn() && resource.data.orgId != null && resource != null (Authenticated user can update/delete)
     * @deny (create, update, delete) if !isSignedIn() (Unauthenticated cannot write)
     * @principle Allows anyone to read assignment details; authenticated user can create, update, and delete
     */
    match /assignments/{assignmentId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.orgId != null;
      allow update, delete: if isSignedIn() && resource.data.orgId != null && resource != null;
    }

    /**
     * @description Allows read and write access to progress documents.
     * @path /progress/{progressId}
     * @allow (get, list) if true (Public read access)
     * @allow (create) if isSignedIn() && request.resource.data.userId == request.auth.uid (Authenticated user can create)
     * @allow (update, delete) if isSignedIn() && resource.data.userId == request.auth.uid && resource != null (Authenticated user can update/delete)
     * @deny (create, update, delete) if !isSignedIn() (Unauthenticated cannot write)
     * @principle Allows anyone to read progress details; authenticated user can create, update, and delete
     */
    match /progress/{progressId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isSignedIn() && resource.data.userId == request.auth.uid && resource != null;
    }

    /**
     * @description Allows read and write access to attempt documents.
     * @path /attempts/{attemptId}
     * @allow (get, list) if true (Public read access)
     * @allow (create) if isSignedIn() && request.resource.data.userId == request.auth.uid (Authenticated user can create)
     * @allow (update, delete) if isSignedIn() && resource.data.userId == request.auth.uid && resource != null (Authenticated user can update/delete)
     * @deny (create, update, delete) if !isSignedIn() (Unauthenticated cannot write)
     * @principle Allows anyone to read attempt details; authenticated user can create, update, and delete
     */
    match /attempts/{attemptId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isSignedIn() && resource.data.userId == request.auth.uid && resource != null;
    }

    /**
     * @description Allows read and write access to subscription plan documents.
     * @path /subscription_plans/{subscriptionPlanId}
     * @allow (get, list) if true (Public read access)
     * @allow (create) if isSignedIn() (Authenticated user can create)
     * @allow (update, delete) if isSignedIn() && resource != null (Authenticated user can update/delete)
     * @deny (create, update, delete) if !isSignedIn() (Unauthenticated cannot write)
     * @principle Allows anyone to read subscription plan details; authenticated user can create, update, and delete
     */
    match /subscription_plans/{subscriptionPlanId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update, delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Allows read and write access to teacher subscription documents.
     * @path /teacher_subscriptions/{teacherSubscriptionId}
     * @allow (get, list) if isSignedIn() && request.auth.uid == resource.data.userId (Teacher can read their own subscription)
     * @allow (create) if isSignedIn() && request.resource.data.userId == request.auth.uid (Teacher can create their own subscription)
     * @allow (update, delete) if isSignedIn() && request.auth.uid == resource.data.userId && resource != null (Teacher can update/delete their own subscription)
     * @deny (create, update, delete) if !isSignedIn() (Unauthenticated cannot write)
     * @principle Allows a teacher to manage their own subscription
     */
    match /teacher_subscriptions/{teacherSubscriptionId} {
      allow get, list: if isSignedIn() && request.auth.uid == resource.data.userId;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isSignedIn() && request.auth.uid == resource.data.userId && resource != null;
    }

    function isSignedIn() {
      return request.auth != null;
    }
  }
}