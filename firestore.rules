/**
 * @file Firebase Security Rules for iLearn Platform
 *
 * @core_philosophy This ruleset enforces a multi-tenant security model where data access is primarily governed by organization membership and user roles. All data is scoped to an organization, and users can only access resources within their organization.
 *
 * @data_structure The Firestore database is structured with top-level collections for core entities like `organizations`, `users`, `classes`, `playlists`, `videos`, `assignments`, `progress`, `attempts`, `subscription_plans`, and `teacher_subscriptions`. Most entities include an `orgId` field to scope data to a specific organization.
 *
 * @key_security_decisions
 *  - Users can only manage their own profile data (`/users/{userId}`).
 *  - Most collections are readable only by authenticated users within the relevant organization, using the `orgId` field for validation.
 *  - Data consistency is enforced on create operations by validating that organization and user IDs in the document match the path parameters.
 *  - List operations are generally restricted to authenticated users within the relevant organization.
 *  - Subscription plans are only manageable by authenticated users, but can be readable by anyone.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Manages access to organization documents.
     * @path /organizations/{orgId}
     * @allow (get, list): Any authenticated user can read organization details.
     * @allow (create): Not allowed. Organizations are created via backend processes.
     * @allow (update, delete): Only allowed via backend processes.
     * @deny (create): if true;
     * @principle Enforces that organizations can only be created and updated by backend processes.
     */
    match /organizations/{orgId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if false;
    }

    /**
     * @description Manages access to user documents.
     * @path /users/{userId}
     * @allow (get): Any authenticated user can read another user's document.
     * @allow (create): Only the user themselves can create their document, and the userId in the document must match the path.
     * @allow (update, delete): Only the user themselves can update or delete their document.
     * @deny (create): if request.auth.uid != request.resource.data.id; //Prevents creating a user document with a mismatched ID.
     * @principle Enforces user-ownership: users can only read, update, or delete their own user document.
     */
    match /users/{userId} {
      allow get: if isSignedIn();
      allow create: if isSelfCreation(userId);
      allow update, delete: if isExistingOwner(userId);
      allow list: if false; //Listing all users is not permitted.
    }

    /**
     * @description Manages access to class documents.
     * @path /classes/{classId}
     * @allow (get, list): Any authenticated user can read or list classes.
     * @allow (create): Only allowed via backend processes with valid orgId.
     * @allow (update, delete): Only allowed via backend processes.
     * @deny (create): if true;
     * @principle Enforces that classes can only be created and updated by backend processes within an organization.
     */
    match /classes/{classId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if false;
    }

    /**
     * @description Manages access to playlist documents.
     * @path /playlists/{playlistId}
     * @allow (get, list): Any authenticated user can read playlists.
     * @allow (create): Only allowed via backend processes with valid orgId.
     * @allow (update, delete): Only allowed via backend processes.
     * @deny (create): if true;
     * @principle Enforces that playlists can only be created and updated by backend processes within an organization.
     */
    match /playlists/{playlistId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if false;
    }

    /**
     * @description Manages access to video documents.
     * @path /videos/{videoId}
     * @allow (get, list): Any authenticated user can read or list videos.
     * @allow (create): Only allowed via backend processes with valid orgId.
     * @allow (update, delete): Only allowed via backend processes.
     * @deny (create): if true;
     * @principle Enforces that videos can only be created and updated by backend processes within an organization.
     */
    match /videos/{videoId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if false;
    }

    /**
     * @description Manages access to segment documents within a video.
     * @path /videos/{videoId}/segments/{segmentId}
     * @allow (get, list): Any authenticated user can read or list segments.
     * @allow (create): Only allowed via backend processes with valid orgId.
     * @allow (update, delete): Only allowed via backend processes.
     * @deny (create): if true;
     * @principle Enforces that segments can only be created and updated by backend processes within an organization.
     */
    match /videos/{videoId}/segments/{segmentId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if false;
    }

    /**
     * @description Manages access to question documents within a video segment.
     * @path /videos/{videoId}/segments/{segmentId}/questions/{questionId}
     * @allow (get, list): Any authenticated user can read or list questions.
     * @allow (create): Only allowed via backend processes with valid orgId.
     * @allow (update, delete): Only allowed via backend processes.
     * @deny (create): if true;
     * @principle Enforces that questions can only be created and updated by backend processes within an organization.
     */
    match /videos/{videoId}/segments/{segmentId}/questions/{questionId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if false;
    }

    /**
     * @description Manages access to assignment documents.
     * @path /assignments/{assignmentId}
     * @allow (get, list): Any authenticated user can read or list assignments.
     * @allow (create): Only allowed via backend processes with valid orgId.
     * @allow (update, delete): Only allowed via backend processes.
     * @deny (create): if true;
     * @principle Enforces that assignments can only be created and updated by backend processes within an organization.
     */
    match /assignments/{assignmentId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if false;
    }

    /**
     * @description Manages access to progress documents.
     * @path /progress/{progressId}
     * @allow (get, list): Any authenticated user can read progress.
     * @allow (create): Only allowed via backend processes with valid userId and assignmentId.
     * @allow (update, delete): Only allowed via backend processes.
     * @deny (create): if true;
     * @principle Enforces that progress can only be created and updated by backend processes with a valid user and assignment.
     */
    match /progress/{progressId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if false;
    }

    /**
     * @description Manages access to attempt documents.
     * @path /attempts/{attemptId}
     * @allow (get, list): Any authenticated user can read attempt data.
     * @allow (create): Only allowed via backend processes with valid userId and questionId.
     * @allow (update, delete): Only allowed via backend processes.
     * @deny (create): if true;
     * @principle Enforces that attempts can only be created and updated by backend processes with a valid user and question.
     */
    match /attempts/{attemptId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if false;
    }

    /**
     * @description Manages access to subscription plan documents.
     * @path /subscription_plans/{subscriptionPlanId}
     * @allow (get, list): Any authenticated user can read subscription plans.
     * @allow (create): Only allowed via backend processes.
     * @allow (update, delete): Only allowed via backend processes.
     * @deny (create): if true;
     * @principle Enforces that subscription plans can only be created and updated by backend processes.
     */
    match /subscription_plans/{subscriptionPlanId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if false;
    }

    /**
     * @description Manages access to teacher subscription documents.
     * @path /teacher_subscriptions/{teacherSubscriptionId}
     * @allow (get, list): Any authenticated user can read teacher subscription data.
     * @allow (create): Only allowed via backend processes with valid userId and subscriptionPlanId.
     * @allow (update, delete): Only allowed via backend processes.
     * @deny (create): if true;
     * @principle Enforces that teacher subscriptions can only be created and updated by backend processes with a valid user and subscription plan.
     */
    match /teacher_subscriptions/{teacherSubscriptionId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if false;
    }

    /**
     * @description Checks if the user is signed in.
     * @return True if the user is authenticated, false otherwise.
     * @principle Verifies user authentication.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user is the owner of the resource, based on the provided userId.
     * @param userId The user ID to compare against the authenticated user's ID.
     * @return True if the authenticated user's ID matches the provided userId.
     * @principle Enforces user-ownership.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user is creating their own user document, by comparing the provided userId with the authenticated user's ID.
     * @param userId The user ID to compare against the authenticated user's ID.
     * @return True if the authenticated user is creating their own document.
     * @principle Enforces that only a user can create their own profile.
     */
    function isSelfCreation(userId) {
        return request.auth.uid == userId && request.resource.data.id == userId;
    }

    /**
     * @description Combines an ownership check with an existence check to prevent accidental operations on non-existent documents.
     * @param userId The user ID that must own the document.
     * @return True if the user owns the document and the document exists.
     * @principle Prevents destructive operations on non-existent documents.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }
  }
}