/**
 * @file Firebase Security Rules for iLearn Platform
 *
 * @core_philosophy This ruleset enforces a multi-tenant security model where data access is primarily governed by organization membership and user roles. It prioritizes authorization independence through denormalization and structural segregation. This means that most authorization checks can be performed on the document being accessed, without needing to perform additional reads on related documents.
 * @data_structure
 *   - /organizations/{orgId}: Stores organization-level data.
 *   - /users/{userId}: Stores user data, including role and organization ID.
 *   - /classes/{classId}: Stores class data, linked to organizations and teachers.
 *   - /playlists/{playlistId}: Stores playlist data, linked to organizations and classes.
 *   - /videos/{videoId}: Stores video data, linked to organizations.
 *   - /videos/{videoId}/segments/{segmentId}: Stores video segment data.
 *   - /videos/{videoId}/segments/{segmentId}/questions/{questionId}: Stores question data for video segments.
 *   - /assignments/{assignmentId}: Stores assignment data, linked to playlists and classes.
 *   - /progress/{progressId}: Stores student progress data, linked to users and assignments.
 *   - /attempts/{attemptId}: Stores student attempt data, linked to users and questions.
 *   - /subscription_plans/{subscriptionPlanId}: Stores subscription plan details.
 *   - /teacher_subscriptions/{teacherSubscriptionId}: Stores teacher subscriptions, including payment information and links to subscription plans.
 * @key_security_decisions
 *   - Strict Organization Scope: Most data is scoped to an organization, and access is generally restricted to members of that organization.
 *   - Role-Based Access: User roles (admin, teacher, student) are used to grant different levels of access.
 *   - Admin Override:  A hardcoded admin user (ilearn@er21.org) can bypass certain restrictions for administrative tasks.
 *   - Explicit Denials: All possible read/write operations are explicitly allowed or denied for each path, ensuring no accidental open access.
 *   - Denormalization for Authorization: Key data like `orgId` and `userId` are duplicated across collections to simplify authorization rules and avoid expensive `get()` calls.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper Functions
    function isSignedIn() {
      return request.auth != null;
    }

    // WARNING: Hardcoded admin user for prototyping purposes.  DO NOT USE IN PRODUCTION.
    function isAdmin() {
      return request.auth.token.email == 'ilearn@er21.org';
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Grants full access to the Organizations collection, only for admin users.
     * @path /organizations/{orgId}
     * @allow (create, update, delete, get, list) - As an admin, create, modify, retrieve, and list organizations.
     * @deny (create, update, delete, get, list) - As a non-admin, perform any operation on organizations.
     * @principle Enforces admin-only access to manage organizations.
     */
    match /organizations/{orgId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Controls access to user documents. Users can only read/write their own document.
     * @path /users/{userId}
     * @allow (create) - A user can create their own document if the userId matches their auth.uid.
     * @allow (get, list, update, delete) - A user can get, update, and delete their own document.
     * @deny (create) - A user cannot create a document with a userId that doesn't match their auth.uid.
     * @deny (get, list, update, delete) - A user cannot get, update, or delete another user's document.
     * @principle Enforces user-ownership for user documents.
     */
    match /users/{userId} {
      allow get, list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Grants full access to the Classes collection, only for admin users.
     * @path /classes/{classId}
     * @allow (create, update, delete, get, list) - As an admin, create, modify, retrieve, and list classes.
     * @deny (create, update, delete, get, list) - As a non-admin, perform any operation on classes.
     * @principle Enforces admin-only access to manage classes.
     */
    match /classes/{classId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Grants full access to the Playlists collection, only for admin users.
     * @path /playlists/{playlistId}
     * @allow (create, update, delete, get, list) - As an admin, create, modify, retrieve, and list playlists.
     * @deny (create, update, delete, get, list) - As a non-admin, perform any operation on playlists.
     * @principle Enforces admin-only access to manage playlists.
     */
    match /playlists/{playlistId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Grants full access to the Videos collection, only for admin users.
     * @path /videos/{videoId}
     * @allow (create, update, delete, get, list) - As an admin, create, modify, retrieve, and list videos.
     * @deny (create, update, delete, get, list) - As a non-admin, perform any operation on videos.
     * @principle Enforces admin-only access to manage videos.
     */
    match /videos/{videoId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Grants full access to the Segments collection, only for admin users.
     * @path /videos/{videoId}/segments/{segmentId}
     * @allow (create, update, delete, get, list) - As an admin, create, modify, retrieve, and list segments.
     * @deny (create, update, delete, get, list) - As a non-admin, perform any operation on segments.
     * @principle Enforces admin-only access to manage segments.
     */
    match /videos/{videoId}/segments/{segmentId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Grants full access to the Questions collection, only for admin users.
     * @path /videos/{videoId}/segments/{segmentId}/questions/{questionId}
     * @allow (create, update, delete, get, list) - As an admin, create, modify, retrieve, and list questions.
     * @deny (create, update, delete, get, list) - As a non-admin, perform any operation on questions.
     * @principle Enforces admin-only access to manage questions.
     */
    match /videos/{videoId}/segments/{segmentId}/questions/{questionId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Grants full access to the Assignments collection, only for admin users.
     * @path /assignments/{assignmentId}
     * @allow (create, update, delete, get, list) - As an admin, create, modify, retrieve, and list assignments.
     * @deny (create, update, delete, get, list) - As a non-admin, perform any operation on assignments.
     * @principle Enforces admin-only access to manage assignments.
     */
    match /assignments/{assignmentId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Grants full access to the Progress collection, only for admin users.
     * @path /progress/{progressId}
     * @allow (create, update, delete, get, list) - As an admin, create, modify, retrieve, and list progress.
     * @deny (create, update, delete, get, list) - As a non-admin, perform any operation on progress.
     * @principle Enforces admin-only access to manage progress.
     */
    match /progress/{progressId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Grants full access to the Attempts collection, only for admin users.
     * @path /attempts/{attemptId}
     * @allow (create, update, delete, get, list) - As an admin, create, modify, retrieve, and list attempts.
     * @deny (create, update, delete, get, list) - As a non-admin, perform any operation on attempts.
     * @principle Enforces admin-only access to manage attempts.
     */
    match /attempts/{attemptId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Grants full access to the Subscription Plans collection, only for admin users.
     * @path /subscription_plans/{subscriptionPlanId}
     * @allow (create, update, delete, get, list) - As an admin, create, modify, retrieve, and list subscription plans.
     * @deny (create, update, delete, get, list) - As a non-admin, perform any operation on subscription plans.
     * @principle Enforces admin-only access to manage subscription plans.
     */
    match /subscription_plans/{subscriptionPlanId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Controls access to teacher subscription documents.
     * @path /teacher_subscriptions/{teacherSubscriptionId}
     * @allow (get, list) - Allow anyone to read.
     * @allow (create) - Only allow if the user ID in the document matches the authenticated user ID.
     * @allow (update, delete) - Only allow if the user ID in the document matches the authenticated user ID and the document exists.
     * @deny (create) - Prevent creating documents with mismatched user IDs.
     * @deny (update, delete) - Prevent updating or deleting documents that don't exist or are owned by another user.
     * @principle Enforces ownership for teacher subscription management.
     */
    match /teacher_subscriptions/{teacherSubscriptionId} {
        allow get, list: if true;
        allow create: if request.resource.data.userId == request.auth.uid;
        allow update, delete: if resource.data.userId == request.auth.uid && resource != null;
    }
  }
}