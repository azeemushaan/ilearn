/**
 * @file Firebase Security Rules for iLearn Platform
 *
 * @Core Philosophy:
 * This ruleset enforces a combination of user-ownership and organization-based access control.
 * Users generally have read/write access only to their own data, while access to organizational data is role-based.
 * The rules are designed to prevent unauthorized data access and modification.
 *
 * @Data Structure:
 * - /organizations/{orgId}: Root collection for organizations.
 * - /users/{userId}: Stores user profiles; 'role' field determines permissions.
 * - /classes/{classId}, /playlists/{playlistId}, /videos/{videoId}: Organizational data, accessible based on orgId.
 * - /assignments/{assignmentId}, /progress/{progressId}, /attempts/{attemptId}: Data related to learning activities.
 * - /subscription_plans/{subscriptionPlanId}, /teacher_subscriptions/{teacherSubscriptionId}: Data related to subscriptions and billing.
 *
 * @Key Security Decisions:
 * - User listing is explicitly denied to prevent information leakage.
 * - Public read access is generally disallowed except where explicitly intended (no such cases exist yet).
 * - Data validation is minimized for prototyping, focusing on authorization-critical fields.
 * - Rules are structured to avoid complex queries and ensure scalability.
 * - The security model assumes the absence of custom claims.
 *
 * @Denormalization for Authorization:
 * - Most documents include 'orgId' to allow for organization-based access control without requiring additional reads.
 * - TeacherSubscription includes 'userId' to allow direct rule-based access control for teachers.
 *
 * @Structural Segregation:
 * - Private user data is stored under /users/{userId}, separate from public organizational data, enabling secure list operations.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows access to organization documents.
     * @path /organizations/{orgId}
     * @allow get, list: if false;
     * @allow create: if false;
     * @allow update: if false;
     * @allow delete: if false;
     * @principle Requires authenticated user.
     */
    match /organizations/{orgId} {
      allow get, list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows access to user documents based on ownership.
     * @path /users/{userId}
     * @allow get: if isSignedIn() && isOwner(userId);
     * @allow list: if false;
     * @allow create: if isSignedIn() && isOwner(userId) && request.resource.data.id == request.auth.uid;
     * @allow update: if isSignedIn() && isOwner(userId) && resource.data.id == request.resource.data.id;
     * @allow delete: if isSignedIn() && isExistingOwner(userId);
     * @principle Enforces document ownership for writes and prevents user listing.
     */
    match /users/{userId} {
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.id == request.auth.uid;
      allow update: if isSignedIn() && isOwner(userId) && resource.data.id == request.resource.data.id;
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Allows access to class documents.
     * @path /classes/{classId}
     * @allow get, list: if false;
     * @allow create: if false;
     * @allow update: if false;
     * @allow delete: if false;
     */
    match /classes/{classId} {
      allow get, list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows access to playlist documents.
     * @path /playlists/{playlistId}
     * @allow get, list: if false;
     * @allow create: if false;
     * @allow update: if false;
     * @allow delete: if false;
     */
    match /playlists/{playlistId} {
      allow get, list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows access to video documents.
     * @path /videos/{videoId}
     * @allow get, list: if false;
     * @allow create: if false;
     * @allow update: if false;
     * @allow delete: if false;
     */
    match /videos/{videoId} {
      allow get, list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows access to segment documents.
     * @path /videos/{videoId}/segments/{segmentId}
     * @allow get, list: if false;
     * @allow create: if false;
     * @allow update: if false;
     * @allow delete: if false;
     */
    match /videos/{videoId}/segments/{segmentId} {
      allow get, list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows access to question documents.
     * @path /videos/{videoId}/segments/{segmentId}/questions/{questionId}
     * @allow get, list: if false;
     * @allow create: if false;
     * @allow update: if false;
     * @allow delete: if false;
     */
    match /videos/{videoId}/segments/{segmentId}/questions/{questionId} {
      allow get, list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows access to assignment documents.
     * @path /assignments/{assignmentId}
     * @allow get, list: if false;
     * @allow create: if false;
     * @allow update: if false;
     * @allow delete: if false;
     */
    match /assignments/{assignmentId} {
      allow get, list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows access to progress documents.
     * @path /progress/{progressId}
     * @allow get, list: if false;
     * @allow create: if false;
     * @allow update: if false;
     * @allow delete: if false;
     */
    match /progress/{progressId} {
      allow get, list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows access to attempt documents.
     * @path /attempts/{attemptId}
     * @allow get, list: if false;
     * @allow create: if false;
     * @allow update: if false;
     * @allow delete: if false;
     */
    match /attempts/{attemptId} {
      allow get, list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows access to subscription plan documents.
     * @path /subscription_plans/{subscriptionPlanId}
     * @allow get, list: if false;
     * @allow create: if false;
     * @allow update: if false;
     * @allow delete: if false;
     */
    match /subscription_plans/{subscriptionPlanId} {
      allow get, list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows access to teacher subscription documents.
     * @path /teacher_subscriptions/{teacherSubscriptionId}
     * @allow get, list: if false;
     * @allow create: if false;
     * @allow update: if false;
     * @allow delete: if false;
     */
    match /teacher_subscriptions/{teacherSubscriptionId} {
      allow get, list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

   }

  /**
   * @description Checks if the user is signed in.
   * @return {boolean} True if the user is signed in, false otherwise.
   */
  function isSignedIn() {
    return request.auth != null;
  }

  /**
   * @description Checks if the user is the owner of the document.
   * @param {string} userId The user ID to check against.
   * @return {boolean} True if the user is the owner, false otherwise.
   */
  function isOwner(userId) {
    return request.auth.uid == userId;
  }

    /**
   * @description Checks if the user is the owner of the document and the resource exists.
   * @param {string} userId The user ID to check against.
   * @return {boolean} True if the user is the owner and the resource exists, false otherwise.
   */
  function isExistingOwner(userId) {
    return isOwner(userId) && resource != null;
  }
}