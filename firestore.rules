/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a multi-tenant security model where coaches (tenants) own their data, and users are associated with a specific coach.
 *
 * Data Structure:
 * - /coaches/{coachId}: Coach profiles and tenant-level settings.
 * - /users/{userId}: User accounts, each belonging to a coach.
 * - /plans/{planId}: Publicly readable plan information.
 * - /subscriptions/{subId}: Coach subscription records.
 * - /payments/{paymentId}: Payment records for coaches.
 * - /invoices/{invoiceId}: Invoices for coaches.
 * - /audit/{auditId}: Audit logs of actions performed within the system.
 * - /settings/theme: Global theme settings (public read-only).
 * - /teacher_subscriptions/{id}: Legacy subscriptions
 * - /subscription_plans/{planId}: Publicly readable subscription plans.
 *
 * Key Security Decisions:
 * - Only authenticated users can access the database.
 * - Users can only manage their own profile data in /users/{userId}.
 * - Coaches have full access to their own data within /coaches/{coachId}.
 * - Listing of users is denied to prevent unauthorized information disclosure.
 * - Public read access is granted to /plans/{planId} and /subscription_plans/{planId}.
 * - The 'admin' role (defined in custom claims) bypasses all other restrictions.
 *
 * Denormalization for Authorization:
 * - The `User` entity has a `coachId` field. This is used to determine which coach a user belongs to and grant coach-level access.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user's ID matches the provided user ID or if the user has the 'admin' role.
     * @param {string} userId - The user ID to compare against.
     * @returns {bool} True if the user is an admin or the owner, false otherwise.
     */
    function isOwner(userId) {
        return isSignedIn() && (request.auth.uid == userId || hasAdminRole());
    }

    /**
     * @description Checks if the authenticated user is the owner and the resource exists.
     * @param {string} userId - The user ID to compare against.
     * @returns {bool} True if the user is the owner and the resource exists, false otherwise.
     */
    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }

    /**
     * @description Checks if the authenticated user has the 'admin' role.
     * @returns {bool} True if the user has the 'admin' role, false otherwise.
     */
    function hasAdminRole() {
        return isSignedIn() && request.auth.token.role == 'admin';
    }


    /**
     * @description Grants access to coach documents, allowing coaches to manage their own data and admins to manage all coach data.
     * @path /coaches/{coachId}
     * @allow (get, create, update, delete) - An admin can perform any operation.
     * @allow (get, update, delete) - A coach (identified by coachId) can perform any operation on their own document.
     * @deny (create, update, delete) - A non-authenticated user cannot perform any operation.
     * @deny (get, create, update, delete) - A regular user cannot perform any operation.
     * @principle Enforces tenant-level ownership for coach data and provides admin override.
     */
    match /coaches/{coachId} {
      allow get: if isSignedIn() && (coachId == request.auth.uid || hasAdminRole());
      allow list: if false; // Disable listing for security.
      allow create: if isSignedIn() && coachId == request.auth.uid;
      allow update: if isExistingOwner(coachId);
      allow delete: if isExistingOwner(coachId);
    }

    /**
     * @description Grants access to user documents, allowing users to manage their own profiles and admins to manage all users.
     * @path /users/{userId}
     * @allow (get, update, delete) - An admin can perform any operation.
     * @allow (get, update, delete) - A user (identified by userId) can perform any operation on their own document.
     * @allow (create) - A user can create their own user document with matching userId
     * @deny (get, create, update, delete) - A non-authenticated user cannot perform any operation.
     * @deny (update, delete) - A regular user cannot modify another user's document.
     * @principle Enforces user-level ownership for profile data and provides admin override.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false; // Disabling listing users collection for security reasons as requested in issue.
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Grants public read access to plan documents, allowing anyone to view plan details.
     * @path /plans/{planId}
     * @allow (get, list) - Any user can read plan details.
     * @deny (create, update, delete) - No user can create, update, or delete plan details (admin only).
     * @principle Allows public read access for marketing and informational purposes, restricts write access to admins.
     */
    match /plans/{planId} {
      allow get, list: if true;
      allow create, update, delete: if hasAdminRole();
    }

    /**
     * @description Grants access to subscription documents, allowing coaches to view their own subscriptions and admins to manage all subscriptions.
     * @path /subscriptions/{subId}
     * @allow (get) - An admin or the coach associated with the subscription can read the subscription.
     * @allow (create, update, delete) - Only admins can create, update, or delete subscriptions.
     * @deny (get, create, update, delete) - A non-authenticated user cannot perform any operation.
     * @deny (create, update, delete) - A regular user cannot modify subscription documents.
     * @principle Enforces tenant-level ownership for subscription data and provides admin override.
     */
    match /subscriptions/{subId} {
      allow get: if isSignedIn() && (resource.data.coachId == request.auth.uid || hasAdminRole());
      allow list: if false;
      allow create, update, delete: if hasAdminRole();
    }

    /**
     * @description Grants access to payment documents, allowing coaches to view their own payments and admins to manage all payments.
     * @path /payments/{paymentId}
     * @allow (get) - An admin or the coach associated with the payment can read the payment.
     * @allow (create, update, delete) - Only admins can create, update, or delete payments.
     * @deny (get, create, update, delete) - A non-authenticated user cannot perform any operation.
     * @deny (create, update, delete) - A regular user cannot modify payment documents.
     * @principle Enforces tenant-level ownership for payment data and provides admin override.
     */
    match /payments/{paymentId} {
      allow get: if isSignedIn() && (resource.data.coachId == request.auth.uid || hasAdminRole());
      allow list: if false;
      allow create, update, delete: if hasAdminRole();
    }

    /**
     * @description Grants access to invoice documents, allowing coaches to view their own invoices and admins to manage all invoices.
     * @path /invoices/{invoiceId}
     * @allow (get) - An admin or the coach associated with the invoice can read the invoice.
     * @allow (create, update, delete) - Only admins can create, update, or delete invoices.
     * @deny (get, create, update, delete) - A non-authenticated user cannot perform any operation.
     * @deny (create, update, delete) - A regular user cannot modify invoice documents.
     * @principle Enforces tenant-level ownership for invoice data and provides admin override.
     */
    match /invoices/{invoiceId} {
      allow get: if isSignedIn() && (resource.data.coachId == request.auth.uid || hasAdminRole());
      allow list: if false;
      allow create, update, delete: if hasAdminRole();
    }

    /**
     * @description Grants access to audit log documents, allowing admins to view audit logs.
     * @path /audit/{auditId}
     * @allow (get, list) - Only admins can read audit logs.
     * @deny (create, update, delete) - No user can create, update, or delete audit logs (admin only).
     * @principle Restricts audit log access to admins for security and compliance.
     */
    match /audit/{auditId} {
      allow get, list: if hasAdminRole();
      allow create, update, delete: if hasAdminRole();
    }

    /**
     * @description Grants public read access to theme settings.
     * @path /settings/theme
     * @allow (get) - Any user can read theme settings.
     * @deny (create, update, delete) - No user can create, update, or delete theme settings (admin only).
     * @principle Allows public read access for global theme configuration.
     */
    match /settings/theme {
      allow get: if true;
      allow list: if false;
      allow create, update, delete: if hasAdminRole();
    }

    /**
     * @description Grants access to legacy teacher subscription documents.
     * @path /teacher_subscriptions/{id}
     */
    match /teacher_subscriptions/{id} {
      allow get, list: if hasAdminRole();
      allow create, update, delete: if hasAdminRole();
    }

    /**
     * @description Grants public read access to subscription plan documents.
     * @path /subscription_plans/{planId}
     * @allow (get, list) - Any user can read plan details.
     * @deny (create, update, delete) - No user can create, update, or delete plan details (admin only).
     * @principle Allows public read access for marketing and informational purposes, restricts write access to admins.
     */
    match /subscription_plans/{planId} {
      allow get, list: if true;
      allow create, update, delete: if hasAdminRole();
    }
  }
}